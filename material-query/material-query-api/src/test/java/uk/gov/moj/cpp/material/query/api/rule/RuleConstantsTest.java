package uk.gov.moj.cpp.material.query.api.rule;import static org.mockito.BDDMockito.given;import static org.mockito.Mockito.times;import static org.mockito.Mockito.verify;import org.junit.jupiter.api.Test;import org.junit.jupiter.api.extension.ExtendWith;import org.mockito.junit.jupiter.MockitoExtension;import uk.gov.moj.cpp.accesscontrol.common.providers.UserAndGroupProvider;import uk.gov.moj.cpp.accesscontrol.drools.Action;import uk.gov.moj.cpp.accesscontrol.progression.providers.ProgressionProvider;import uk.gov.moj.cpp.accesscontrol.test.utils.BaseDroolsAccessControlTest;import uk.gov.moj.cpp.material.query.api.accesscontrol.RuleConstants;import java.util.Arrays;import java.util.HashMap;import java.util.Map;import java.util.UUID;import com.fasterxml.jackson.core.JsonProcessingException;import com.google.common.collect.ImmutableMap;import org.kie.api.runtime.ExecutionResults;import org.mockito.Mock;@ExtendWith(MockitoExtension.class)public class RuleConstantsTest extends BaseDroolsAccessControlTest {    protected Action action;    @Mock    protected UserAndGroupProvider userAndGroupProvider;    @Mock    protected ProgressionProvider progressionProvider;    public RuleConstantsTest() {        super("QUERY_API_SESSION");    }    @Override    protected Map<Class<?>, Object> getProviderMocks() {        return ImmutableMap.<Class<?>, Object>builder()                .put(UserAndGroupProvider.class, userAndGroupProvider)                .put(ProgressionProvider.class, progressionProvider)                .build();    }    @Test    public void shouldNotAllowAuthorisedUserWithPermissionNonCpsDocuments() throws JsonProcessingException {        final Map<String, String> metadata = new HashMap();        metadata.putIfAbsent("id", UUID.randomUUID().toString());        metadata.putIfAbsent("name", "material.query.material");        action = createActionFor(metadata);        given(userAndGroupProvider.hasPermission(action,RuleConstants.getNonCpsDocumentReadPermission())).willReturn(false);        final ExecutionResults results = executeRulesWith(action);        assertFailureOutcome(results);        verify(userAndGroupProvider, times(1)).hasPermission(action, RuleConstants.getNonCpsDocumentReadPermission());    }    @Test    public void shouldAllowAuthorisedUserWithPermissionToNonCpsDocuments() throws JsonProcessingException {        final Map<String, String> metadata = new HashMap();        metadata.putIfAbsent("id", UUID.randomUUID().toString());        metadata.putIfAbsent("name", "material.query.material");        action = createActionFor(metadata);        given(userAndGroupProvider.hasPermission(action,RuleConstants.getNonCpsDocumentReadPermission())).willReturn(true);        given(progressionProvider.isMaterialFromCPSProsecutedCase(action)).willReturn(true);        final ExecutionResults results = executeRulesWith(action);        assertSuccessfulOutcome(results);        verify(userAndGroupProvider, times(1)).hasPermission(action, RuleConstants.getNonCpsDocumentReadPermission());    }}